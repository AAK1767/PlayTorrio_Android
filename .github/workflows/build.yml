name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm install
      - name: Setup Windows Players
        run: |
          if (Test-Path "mpv.rar") { 7z x mpv.rar -y }
          if (Test-Path "mpv.js-master-updated.rar") { 7z x mpv.js-master-updated.rar -y }
          elseif (Test-Path "mpv.zip") { Expand-Archive -Path mpv.zip -DestinationPath mpv-temp -Force }
          if (!(Test-Path "mpv/mpv.exe")) { Write-Host "MPV missing" }
          if (Test-Path "vlc.rar") { 7z x vlc.rar -y }
          # Extract yt-dlp binary for Windows (if provided) and remove archive afterwards
          if (Test-Path "yt.rar") {
            7z x yt.rar -y
            Remove-Item yt.rar -Force
          }
      - name: Verify Icons
        run: |
          if (!(Test-Path build)) { mkdir build }
          if (Test-Path icon.ico) { Copy-Item icon.ico build/icon.ico -Force }
      - name: Check for yt-dlp binary on Windows
        run: |
          # Check if yt-dlp.exe exists after extraction
          if (Test-Path "yt\yt-dlp.exe") {
            Write-Host "✓ yt-dlp.exe found in yt folder"
          } elseif (Test-Path "yt\yt-dlp_windows.exe") {
            Write-Host "✓ yt-dlp_windows.exe found in yt folder"
          } else {
            Write-Error "❌ yt-dlp binary not found in expected location"
            exit 1
          }
      - name: Build Windows Installer
        run: npm run build -- --win --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm install
      - name: Prepare resources
        run: |
          mkdir -p mpv VLC build
          [ -f icon.png ] && cp icon.png build/icon.png || true
      - name: Extract yt-dlp binary for Linux
        run: |
          if [ -f linuxyt.rar ]; then
            sudo apt-get update -y
            sudo apt-get install -y p7zip-full
            7z x linuxyt.rar -y
            rm -f linuxyt.rar
          fi
      - name: Check for yt-dlp binary on Linux
        run: |
          if [ -f linyt/yt-dlp_linux ] || [ -f linyt/yt-dlp ]; then
            echo "✓ yt-dlp binary found in linyt folder"
          else
            echo "❌ yt-dlp binary not found in expected location" && exit 1
          fi
      - name: Build Linux Packages
        run: npm run build -- --linux --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Verify AppImage
        run: |
          set -e
          ls dist/*.AppImage
          chmod +x dist/*.AppImage
          echo "AppImage artifacts ready"

  build-macos-x64:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        timeout-minutes: 45
        run: npm install --verbose || npm install --verbose || npm install --verbose
      - name: Download MPV (x64)
        run: |
          curl -fL https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz || true
          mkdir -p mpv
          [ -f mpv.tar.gz ] && tar -xzf mpv.tar.gz -C mpv || true
      - name: Extract yt-dlp binary for macOS
        run: |
          if [ -f macyt.rar ]; then
            # Use unrar for macOS because p7zip may not support some RAR5 methods
            brew install unrar || true
            unrar x -o+ macyt.rar
            rm -f macyt.rar
          fi
      - name: Check for yt-dlp binary on macOS x64
        run: |
          if [ -f macyt/yt-dlp_macos ] || [ -f macyt/yt-dlp ]; then
            echo "✓ yt-dlp binary found in macyt folder"
          else
            echo "❌ yt-dlp binary not found in expected location" && exit 1
          fi
      - name: Build macOS x64 DMG
        run: npm run build -- --mac --x64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      - name: Strip quarantine
        run: |
          xattr -cr dist/*x64*/PlayTorrio.app || true

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        timeout-minutes: 45
        run: npm install --verbose || npm install --verbose || npm install --verbose
      - name: Download MPV (arm64)
        run: |
          curl -fL https://laboratory.stolendata.net/~djinn/mpv_osx/mpv-latest.tar.gz -o mpv.tar.gz || true
          mkdir -p mpv
          [ -f mpv.tar.gz ] && tar -xzf mpv.tar.gz -C mpv || true
      - name: Extract yt-dlp binary for macOS
        run: |
          if [ -f macyt.rar ]; then
            # Use unrar for macOS because p7zip may not support some RAR5 methods
            brew install unrar || true
            unrar x -o+ macyt.rar
            rm -f macyt.rar
          fi
      - name: Check for yt-dlp binary on macOS arm64
        run: |
          if [ -f macyt/yt-dlp_macos ] || [ -f macyt/yt-dlp ]; then
            echo "✓ yt-dlp binary found in macyt folder"
          else
            echo "❌ yt-dlp binary not found in expected location" && exit 1
          fi
      - name: Build macOS arm64 DMG
        run: npm run build -- --mac --arm64 --publish always
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
      - name: Strip quarantine
        run: |
          xattr -cr dist/*arm64*/PlayTorrio.app || true

  finalize-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos-x64, build-macos-arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Read version
        id: ver
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - name: Ensure tag uses v prefix
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          echo "Using tag: $TAG"
      - name: Update GitHub Release (title + notes, keep draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          generate_release_notes: true
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}